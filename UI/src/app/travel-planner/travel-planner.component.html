<div class="app-container">
  <!-- Sidebar -->
  <div class="sidebar">
    <h2 class="sidebar-title">‚öôÔ∏è Options</h2>
    <div class="search-mode-section">
      <h3>Search Mode</h3>
      <div class="radio-group">
        <label class="radio-option">
          <input type="radio" [(ngModel)]="searchMode" value="complete" name="searchMode">
          <span>Complete (Flights + Hotels + Itinerary)</span>
        </label>
        <label class="radio-option">
          <input type="radio" [(ngModel)]="searchMode" value="flights" name="searchMode">
          <span>Flights Only</span>
        </label>
        <label class="radio-option">
          <input type="radio" [(ngModel)]="searchMode" value="hotels" name="searchMode">
          <span>Hotels Only</span>
        </label>
      </div>
    </div>
    <div class="sidebar-footer">
      <p>AI-Powered Travel Planner v2.0</p>
      <p>¬© 2025 Travel AI Solutions</p>
    </div>
  </div>
  <!-- Main Content -->
  <div class="main-content">
    <header class="header">
      <h1>‚úàÔ∏è AI-Powered Travel Planner</h1>
      <p>Find flights, hotels, and get personalized recommendations with AI! Create your perfect travel itinerary in seconds.</p>
    </header>
    <!-- Search Form -->
    <form [formGroup]="travelForm" (ngSubmit)="onSubmit()" class="search-form">
      <div class="form-grid">
        <!-- Flight Details -->
        <div class="form-section">
          <h2>üõ´ Flight Details</h2>
          <div class="form-group">
            <label>Departure Airport (IATA code)</label>
            <input type="text" formControlName="origin" class="form-control" placeholder="BOM">
          </div>
          <div class="form-group">
            <label>Arrival Airport (IATA code)</label>
            <input type="text" formControlName="destination" class="form-control" placeholder="NRT">
          </div>
          <div class="form-group">
            <label>Departure Date</label>
            <input type="date" formControlName="outboundDate" class="form-control">
          </div>
          <div class="form-group">
            <label>Return Date</label>
            <input type="date" formControlName="returnDate" class="form-control">
          </div>
        </div>
        <!-- Hotel Details -->
        <div class="form-section">
          <h2>üè® Hotel Details</h2>
          <div formArrayName="hotelLocations">
            <div *ngFor="let hotelCtrl of hotelLocations.controls; let i = index" [formGroupName]="i" class="hotel-location-group">
              <div class="form-group">
                <label class="checkbox-label">
                  <input type="checkbox" formControlName="useFlightDestination">
                  Use flight destination for hotel
                </label>
              </div>
              <div class="form-group" *ngIf="!hotelCtrl.get('useFlightDestination')?.value">
                <label>Hotel Location</label>
                <input type="text" formControlName="location" class="form-control" placeholder="Enter location">
              </div>
              <div class="form-group" *ngIf="hotelCtrl.get('useFlightDestination')?.value">
                <div class="info-message">
                  Using flight destination ({{travelForm.get('destination')?.value}}) for hotel search
                </div>
              </div>
              <div class="form-group">
                <label>Check-In Date</label>
                <input type="date" formControlName="checkInDate" class="form-control">
              </div>
              <div class="form-group">
                <label>Check-Out Date</label>
                <input type="date" formControlName="checkOutDate" class="form-control">
              </div>
              <button type="button" class="select-btn" (click)="removeHotelLocation(i)" *ngIf="hotelLocations.length > 1">Remove</button>
              <hr *ngIf="i < hotelLocations.length - 1">
            </div>
            <button type="button" class="select-btn" (click)="addHotelLocation()">+ Add Another Location</button>
          </div>
        </div>
      </div>
      <div class="submit-section">
        <button type="submit" class="search-btn" [disabled]="loading || travelForm.invalid">
          <span *ngIf="loading">Searching...</span>
          <span *ngIf="!loading">üîç Search</span>
        </button>
      </div>
    </form>
    <!-- Loading Spinner -->
    <div *ngIf="loading" class="loading-spinner">
      <div class="spinner"></div>
      <p>Searching for the perfect travel options for you...</p>
    </div>
    <!-- Error Messages -->
    <div *ngIf="errorMessage" class="error-message">
      {{ errorMessage }}
    </div>
    <!-- Results -->
    <div *ngIf="searchResults && !loading" class="results-container">
      <!-- Tabs -->
      <div class="tabs">
        <button *ngIf="searchMode !== 'hotels'" 
                class="tab-button" 
                [class.active]="activeTab === 'flights'"
                (click)="activeTab = 'flights'">
          ‚úàÔ∏è Flights
        </button>
        <button *ngIf="searchMode !== 'flights'" 
                class="tab-button" 
                [class.active]="activeTab === 'hotels'"
                (click)="activeTab = 'hotels'">
          üè® Hotels
        </button>
        <button class="tab-button" 
                [class.active]="activeTab === 'recommendations'"
                (click)="activeTab = 'recommendations'">
          üèÜ AI Recommendations
        </button>
        <button *ngIf="searchMode === 'complete' && searchResults.itinerary" 
                class="tab-button" 
                [class.active]="activeTab === 'itinerary'"
                (click)="activeTab = 'itinerary'">
          üìÖ Itinerary
        </button>
      </div>
      <!-- Tab Content -->
      <div class="tab-content">
        <!-- Flights Tab -->
        <div *ngIf="activeTab === 'flights' && searchMode !== 'hotels'" class="flights-section">
          <h3>‚úàÔ∏è Available Flights from {{travelForm.get('origin')?.value}} to {{travelForm.get('destination')?.value}}</h3>
          <div *ngIf="searchResults.flights.length > 0" class="flights-list">
            <div *ngFor="let flight of searchResults.flights; let i = index" class="flight-row">
              <div class="flight-row-main">
                <!-- Airline logo and name -->
                <div class="flight-airline-col">
                  <img *ngIf="flight.legs && flight.legs.length > 0 && flight.legs[0].airline_logo"
                       [src]="flight.legs[0].airline_logo"
                       class="airline-logo"
                       alt="{{flight.airline}} logo" />
                  <div>
                    <div class="flight-airline-name">{{ flight.airline }}</div>
                    <div class="flight-class">{{ flight.travel_class }}</div>
                  </div>
                </div>
                <!-- Departure info -->
                <div class="flight-time-col">
                  <div class="flight-time-main">
                    <span class="flight-time">{{ flight.legs && flight.legs.length > 0 ? flight.legs[0].departure_time : flight.departure }}</span>
                    <span class="flight-airport">{{ flight.legs && flight.legs.length > 0 ? flight.legs[0].departure_airport : travelForm.get('origin')?.value }}</span>
                  </div>
                </div>
                <!-- Arrow and duration -->
                <div class="flight-middle-col">
                  <span class="flight-arrow">‚Üí</span>
                  <span class="flight-duration">{{ formatDuration(flight.duration) }}</span>
                  <span class="flight-stops">{{ flight.stops }}</span>
                  <span *ngIf="flight.layovers && flight.layovers.length" class="flight-layover-dot">‚Ä¢</span>
                  <span *ngIf="flight.layovers && flight.layovers.length">
                    {{ flight.layovers.length }} layover{{ flight.layovers.length > 1 ? 's' : '' }}
                  </span>
                </div>
                <!-- Arrival info -->
                <div class="flight-time-col">
                  <div class="flight-time-main">
                    <span class="flight-time">
                      {{ flight.legs && flight.legs.length > 0 ? flight.legs[flight.legs.length-1].arrival_time : flight.arrival }}
                    </span>
                    <span class="flight-airport">
                      {{ flight.legs && flight.legs.length > 0 ? flight.legs[flight.legs.length-1].arrival_airport : travelForm.get('destination')?.value }}
                    </span>
                  </div>
                </div>
                <!-- Price and select -->
                <div class="flight-price-col">
                  <div class="flight-price">‚Çπ{{ flight.price }}</div>
                  <button class="select-btn modern-select-btn">Select flight</button>
                  <button *ngIf="flight.return_flights?.length"
                          class="select-btn"
                          (click)="returnFlightsOpen[i] = !returnFlightsOpen[i]">
                    {{ returnFlightsOpen[i] ? 'Hide' : 'Show' }} return flights
                  </button>
                </div>
              </div>
              <!-- Details row (optional, can be collapsible) -->
              <div class="flight-row-details">
                <div *ngIf="flight.layovers && flight.layovers.length" class="flight-layovers-summary">
                  <span *ngFor="let lay of flight.layovers; let idx = index">
                    üõë <strong>{{ lay.airport }}</strong> ({{ lay.airport_id }}) - {{ formatDuration(lay.duration) }}<span *ngIf="lay.overnight"> (Overnight)</span>
                    <span *ngIf="flight.layovers && idx < flight.layovers.length - 1">|</span>
                  </span>
                </div>
                <div *ngIf="flight.legs && flight.legs.length > 0" class="flight-legs-summary">
                  <ul>
                    <li *ngFor="let leg of flight.legs">
                      <span>üõ´ <strong>{{ leg.departure_airport }}</strong> at {{ leg.departure_time }}</span>
                      <span>‚Üí üõ¨ <strong>{{ leg.arrival_airport }}</strong> at {{ leg.arrival_time }}</span>
                      <span> | ‚úàÔ∏è {{ leg.airline }} ({{ leg.flight_number }}), {{ leg.travel_class }}, {{ formatDuration(leg.duration) }}</span>
                    </li>
                  </ul>
                </div>
              </div>
              <!-- Return Flights Section -->
              <div *ngIf="flight.return_flights?.length && returnFlightsOpen[i]"
                   class="return-flights"
                   [@collapseReturn]>
                <div *ngFor="let ret of flight.return_flights; let j = index" class="return-flight-card">
                  <div class="flight-row-main">
                    <div class="flight-airline-col">
                      <img *ngIf="ret.legs && ret.legs.length > 0 && ret.legs[0].airline_logo"
                           [src]="ret.legs[0].airline_logo"
                           class="airline-logo"
                           alt="{{ret.airline}} logo" />
                      <div>
                        <div class="flight-airline-name">{{ ret.airline }}</div>
                        <div class="flight-class">{{ ret.travel_class }}</div>
                      </div>
                    </div>
                    <div class="flight-time-col">
                      <div class="flight-time-main">
                        <span class="flight-time">
                          {{ ret.legs && ret.legs.length > 0 ? ret.legs[0].departure_time : '' }}
                        </span>
                        <span class="flight-airport">
                          {{ ret.legs && ret.legs.length > 0 ? ret.legs[0].departure_airport : '' }}
                        </span>
                      </div>
                    </div>
                    <div class="flight-middle-col">
                      <span class="flight-arrow">‚Üí</span>
                      <span class="flight-duration">{{ formatDuration(ret.duration) }}</span>
                      <span class="flight-stops">{{ ret.stops }}</span>
                      <span *ngIf="ret.layovers && ret.layovers.length" class="flight-layover-dot">‚Ä¢</span>
                      <span *ngIf="ret.layovers && ret.layovers.length">
                        {{ ret.layovers.length }} layover{{ ret.layovers.length > 1 ? 's' : '' }}
                      </span>
                    </div>
                    <div class="flight-time-col">
                      <div class="flight-time-main">
                        <span class="flight-time">
                          {{ ret.legs && ret.legs.length > 0 ? ret.legs[ret.legs.length-1].arrival_time : '' }}
                        </span>
                        <span class="flight-airport">
                          {{ ret.legs && ret.legs.length > 0 ? ret.legs[ret.legs.length-1].arrival_airport : '' }}
                        </span>
                      </div>
                    </div>
                    <div class="flight-price-col">
                      <div class="flight-price">‚Çπ{{ ret.price }}</div>
                    </div>
                  </div>
                    <!-- Show layovers for return flight -->
                    <div *ngIf="ret.layovers && ret.layovers.length" class="flight-layovers-summary">
                    <span *ngFor="let lay of ret.layovers; let idx = index">
                      üõë <strong>{{ lay.airport }}</strong> ({{ lay.airport_id }}) - {{ formatDuration(lay.duration) }}<span *ngIf="lay.overnight"> (Overnight)</span>
                      <span *ngIf="ret.layovers && idx < ret.layovers.length - 1">|</span>
                    </span>
                    </div>
                    <!-- Show legs for return flight -->
                    <div *ngIf="ret.legs && ret.legs.length > 0" class="flight-legs-summary">
                    <ul>
                      <li *ngFor="let leg of ret.legs">
                      <span>üõ´ <strong>{{ leg.departure_airport }}</strong> at {{ leg.departure_time }}</span>
                      <span>‚Üí üõ¨ <strong>{{ leg.arrival_airport }}</strong> at {{ leg.arrival_time }}</span>
                      <span> | ‚úàÔ∏è {{ leg.airline }} ({{ leg.flight_number }}), {{ leg.travel_class }}, {{ formatDuration(leg.duration) }}</span>
                      </li>
                    </ul>
                    </div>
                </div>
              </div>
            </div>
          </div>
          <div *ngIf="searchResults.flights.length === 0" class="no-results">
            No flights found for your search criteria.
          </div>
        </div>
        <!-- Hotels Tab -->
        <div *ngIf="activeTab === 'hotels' && searchMode !== 'flights'" class="hotels-section">
          <ng-container *ngIf="searchResults.hotels_grouped.length > 0; else noHotels">
            <div *ngFor="let group of searchResults.hotels_grouped; let idx = index" class="hotel-location-group">
              <h3>
                üè® Hotels in {{ group.location }}
                <span style="font-weight:normal;">
                  ({{ group.check_in_date }} to {{ group.check_out_date }})
                </span>
              </h3>
              <div *ngIf="group.hotels.length > 0" class="hotels-grid">
                <div *ngFor="let hotel of group.hotels" class="hotel-card">
                  <h4>üè® {{hotel.name}}</h4>
                  <div class="hotel-details">
                    <p>üí∞ <strong>Price:</strong> ‚Çπ{{hotel.price}} per night</p>
                    <p>‚≠ê <strong>Rating:</strong> {{hotel.rating}}</p>
                    <p>üìç <strong>Location:</strong> {{hotel.location}}</p>
                  </div>
                  <div class="hotel-actions">
                    <button class="select-btn">üîñ Select</button>
                    <a [href]="hotel.link" target="_blank" class="details-btn">üîó Details</a>
                  </div>
                </div>
              </div>
              <div *ngIf="group.hotels.length === 0" class="no-results">
                No hotels found for this location.
              </div>
              <hr *ngIf="idx < searchResults.hotels_grouped.length - 1">
            </div>
          </ng-container>
          <ng-template #noHotels>
            <div class="no-results">No hotels found for your search criteria.</div>
          </ng-template>
        </div>
        <!-- Recommendations Tab -->
        <div *ngIf="activeTab === 'recommendations'" class="recommendations-section">
          <div *ngIf="searchMode !== 'hotels' && searchResults.ai_flight_recommendation" class="recommendation-card">
            <h3>‚úàÔ∏è AI Flight Recommendation</h3>
            <div markdown [data]="searchResults.ai_flight_recommendation"></div>
          </div>
          <!-- Show all hotel recommendations -->
          <ng-container *ngIf="searchMode !== 'flights' && searchResults.ai_hotel_recommendations">
            <div *ngFor="let rec of searchResults.ai_hotel_recommendations; let i = index" class="recommendation-card">
              <h3>üè® AI Hotel Recommendation for Location {{i + 1}}</h3>
              <div markdown [data]="rec"></div>
            </div>
          </ng-container>
        </div>
        <!-- Itinerary Tab -->
        <div *ngIf="activeTab === 'itinerary' && searchMode === 'complete'" class="itinerary-section">
          <h3>üìÖ Your Travel Itinerary</h3>
          <div class="itinerary-content" markdown [data]="itineraryMarkdown"></div>
          <button class="download-btn" (click)="downloadItinerary()">üì• Download Itinerary</button>
        </div>
      </div>
    </div>
  </div>
</div>